<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫àÁ¥ÑËÄÖ‰∏ÄË¶ß - <%= event.title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container admin-container">
        <header>
            <h1>‰∫àÁ¥ÑËÄÖ‰∏ÄË¶ß</h1>
            <a href="/admin" class="back-link">‚Üê ÁÆ°ÁêÜÁîªÈù¢„Å´Êàª„Çã</a>
        </header>
        
        <main>
            <!-- „Ç§„Éô„É≥„ÉàÊÉÖÂ†± -->
            <section class="event-info-section">
                <div class="event-summary">
                    <div class="event-type-badge <%= event.event_type %>">
                        <% if (event.event_type === 'business') { %>
                            üíº „Éì„Ç∏„Éç„Çπ
                        <% } else { %>
                            üéâ „Ç§„Éô„É≥„Éà
                        <% } %>
                    </div>
                    <h2><%= event.title %></h2>
                    <div class="event-details">
                        <p><span class="icon">üìÖ</span> <%= event.formatted_date %> <%= event.formatted_time %></p>
                        <p><span class="icon">üë•</span> <%= reservations.length %>/<%= event.capacity %> Âêç</p>
                        <% if (event.description) { %>
                            <p class="description"><%= event.description %></p>
                        <% } %>
                    </div>
                    
                    <div class="quick-actions">
                        <a href="/admin/qr/<%= event.id %>" class="action-btn qr-btn">üì± QR„Ç≥„Éº„ÉâÁîüÊàê</a>
                        <button onclick="printReservations()" class="action-btn print-btn">üñ®Ô∏è Âç∞Âà∑</button>
                        <button onclick="exportCSV()" class="action-btn export-btn">üìä CSVÂá∫Âäõ</button>
                    </div>
                </div>
            </section>
            
            <!-- ‰∫àÁ¥ÑËÄÖ„É™„Çπ„Éà -->
            <section class="reservations-section">
                <h3>‰∫àÁ¥ÑËÄÖ„É™„Çπ„Éà</h3>
                <% if (reservations.length === 0) { %>
                    <div class="no-reservations">
                        <p>„Åæ„Å†‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                    </div>
                <% } else { %>
                    <div class="reservations-table-container">
                        <table class="reservations-table" id="reservationsTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>‰∫àÁ¥Ñ„Ç≥„Éº„Éâ</th>
                                    <% 
                                        // ÂÖ®‰∫àÁ¥Ñ„Éá„Éº„Çø„Åã„Çâ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Çã„Éï„Ç£„Éº„É´„Éâ„ÇíÁâπÂÆö
                                        const allFields = new Set();
                                        reservations.forEach(reservation => {
                                            Object.keys(reservation.parsed_data).forEach(key => {
                                                allFields.add(key);
                                            });
                                        });
                                        const fieldKeys = Array.from(allFields);
                                    %>
                                    <% fieldKeys.forEach(function(key) { %>
                                        <th>
                                            <% if (key === 'participant_name') { %>ÂèÇÂä†ËÄÖÊ∞èÂêç
                                            <% } else if (key === 'company_name') { %>‰ºöÁ§æÂêç
                                            <% } else if (key === 'position') { %>ÂΩπËÅ∑
                                            <% } else if (key === 'contact_info') { %>ÈÄ£Áµ°ÂÖà
                                            <% } else if (key === 'email') { %>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
                                            <% } else if (key === 'phone') { %>ÈõªË©±Áï™Âè∑
                                            <% } else if (key === 'age') { %>Âπ¥ÈΩ¢
                                            <% } else if (key === 'gender') { %>ÊÄßÂà•
                                            <% } else if (key === 'occupation') { %>ËÅ∑Ê•≠
                                            <% } else if (key === 'address') { %>‰ΩèÊâÄ
                                            <% } else if (key === 'dietary_restrictions') { %>È£ü‰∫ãÂà∂Èôê
                                            <% } else if (key === 'emergency_contact') { %>Á∑äÊÄ•ÈÄ£Áµ°ÂÖà
                                            <% } else if (key === 'participation_method') { %>ÂèÇÂä†ÊñπÊ≥ï
                                            <% } else { %><%= key %>
                                            <% } %>
                                        </th>
                                    <% }); %>
                                    <th>‰∫àÁ¥ÑÊó•ÊôÇ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservations.forEach(function(reservation, index) { %>
                                    <tr>
                                        <td><%= index + 1 %></td>
                                        <td class="reservation-code"><%= reservation.reservation_code %></td>
                                        <% fieldKeys.forEach(function(key) { %>
                                            <td><%= reservation.parsed_data[key] || '-' %></td>
                                        <% }); %>
                                        <td><%= new Date(reservation.created_at).toLocaleString('ja-JP') %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Áµ±Ë®àÊÉÖÂ†± -->
                    <div class="statistics">
                        <h4>Áµ±Ë®àÊÉÖÂ†±</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Á∑è‰∫àÁ¥ÑÊï∞</span>
                                <span class="stat-value"><%= reservations.length %></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ÊÆã„ÇäÂ∏≠Êï∞</span>
                                <span class="stat-value"><%= event.capacity - reservations.length %></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Á®ºÂÉçÁéá</span>
                                <span class="stat-value"><%= Math.round((reservations.length / event.capacity) * 100) %>%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂèÇÂä†ÊñπÊ≥ïÂà•Áµ±Ë®àÔºàÈÅ∏ÊäûËÇ¢„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ -->
                    <% if (event.participation_options) { %>
                        <div class="participation-stats">
                            <h4>ÂèÇÂä†ÊñπÊ≥ïÂà•Áµ±Ë®à</h4>
                            <div class="participation-grid">
                                <% 
                                    const options = JSON.parse(event.participation_options);
                                    options.forEach(option => {
                                        const count = reservations.filter(r => r.parsed_data.participation_method === option).length;
                                %>
                                    <div class="participation-item">
                                        <span class="participation-option"><%= option %></span>
                                        <span class="participation-count"><%= count %>Âêç</span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>
                    
                    <!-- „Éï„Ç£„Éº„É´„ÉâÂà•Áµ±Ë®à -->
                    <% if (fieldKeys.includes('gender')) { %>
                        <div class="field-stats">
                            <h4>ÊÄßÂà•Áµ±Ë®à</h4>
                            <div class="field-stats-grid">
                                <% 
                                    const genderStats = {};
                                    reservations.forEach(r => {
                                        const gender = r.parsed_data.gender || 'Êú™ÂõûÁ≠î';
                                        genderStats[gender] = (genderStats[gender] || 0) + 1;
                                    });
                                    Object.keys(genderStats).forEach(gender => {
                                %>
                                    <div class="field-stat-item">
                                        <span class="field-stat-label"><%= gender %></span>
                                        <span class="field-stat-value"><%= genderStats[gender] %>Âêç</span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>
                <% } %>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2024 ‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†</p>
        </footer>
    </div>
    
    <script>
        function printReservations() {
            window.print();
        }
        
        function exportCSV() {
            const table = document.getElementById('reservationsTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => {
                    const content = cell.textContent.trim();
                    // CSV„Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜ
                    if (content.includes(',') || content.includes('"') || content.includes('\n')) {
                        return `"${content.replace(/"/g, '""')}"`;
                    }
                    return content;
                }).join(',');
            }).join('\n');
            
            // BOM‰ªò„Åç„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàExcelÂØæÂøúÔºâ
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const eventTitle = '<%= event.title %>';
            const eventDate = '<%= event.date %>';
            const fileName = `${eventTitle}_‰∫àÁ¥ÑËÄÖ‰∏ÄË¶ß_${eventDate}.csv`;
            
            if (navigator.msSaveBlob) {
                // IEÂØæÂøú
                navigator.msSaveBlob(blob, fileName);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // „ÉÜ„Éº„Éñ„É´„ÅÆË°å„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞Ë°®Á§∫Ôºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
        document.querySelectorAll('.reservations-table tbody tr').forEach(row => {
            row.addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
        });
    </script>
    
    <style>
        .event-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .event-type-badge.business {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .event-type-badge.personal {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .export-btn {
            background-color: #28a745;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #218838;
        }
        
        .participation-stats, .field-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .participation-grid, .field-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .participation-item, .field-stat-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .participation-option, .field-stat-label {
            font-weight: bold;
        }
        
        .participation-count, .field-stat-value {
            background-color: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        @media print {
            .quick-actions, .back-link, footer, header .back-link {
                display: none !important;
            }
            
            .container {
                margin: 0;
                padding: 0;
            }
            
            .reservations-table {
                font-size: 10px;
            }
            
            .reservations-table td, .reservations-table th {
                padding: 6px 4px;
            }
        }
        
        @media (max-width: 768px) {
            .reservations-table {
                font-size: 0.7rem;
            }
            
            .reservations-table td, .reservations-table th {
                padding: 4px 2px;
            }
        }
    </style>
</body>
</html>
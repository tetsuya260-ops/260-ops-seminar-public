<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„è€…ä¸€è¦§ - <%= event.title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container admin-container">
        <header>
            <h1>äºˆç´„è€…ä¸€è¦§</h1>
            <a href="/admin" class="back-link">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</a>
        </header>
        
        <main>
            <!-- ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± -->
            <section class="event-info-section">
                <div class="event-summary">
                    <div class="event-type-badge <%= event.event_type %>">
                        <% if (event.event_type === 'business') { %>
                            ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹
                        <% } else { %>
                            ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆ
                        <% } %>
                    </div>
                    <h2><%= event.title %></h2>
                    <div class="event-details">
                        <p><span class="icon">ğŸ“…</span> <%= event.formatted_date %> <%= event.formatted_time %></p>
                        <p><span class="icon">ğŸ‘¥</span> <%= reservations.length %>/<%= event.capacity %> å</p>
                        <% if (event.description) { %>
                            <p class="description"><%= event.description %></p>
                        <% } %>
                    </div>
                    
                    <div class="quick-actions">
                        <a href="/admin/qr/<%= event.id %>" class="action-btn qr-btn">ğŸ“± QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</a>
                        <button onclick="printReservations()" class="action-btn print-btn">ğŸ–¨ï¸ å°åˆ·</button>
                        <button onclick="exportCSV()" class="action-btn export-btn">ğŸ“Š CSVå‡ºåŠ›</button>
                    </div>
                </div>
            </section>
            
            <!-- äºˆç´„è€…ãƒªã‚¹ãƒˆ -->
            <section class="reservations-section">
                <h3>äºˆç´„è€…ãƒªã‚¹ãƒˆ</h3>
                <% if (reservations.length === 0) { %>
                    <div class="no-reservations">
                        <p>ã¾ã äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                <% } else { %>
                    <div class="reservations-table-container">
                        <table class="reservations-table" id="reservationsTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>äºˆç´„ã‚³ãƒ¼ãƒ‰</th>
                                    <% 
                                        // å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç‰¹å®š
                                        const allFields = new Set();
                                        reservations.forEach(reservation => {
                                            Object.keys(reservation.parsed_data).forEach(key => {
                                                allFields.add(key);
                                            });
                                        });
                                        const fieldKeys = Array.from(allFields);
                                    %>
                                    <% fieldKeys.forEach(function(key) { %>
                                        <th>
                                            <% if (key === 'participant_name') { %>å‚åŠ è€…æ°å
                                            <% } else if (key === 'company_name') { %>ä¼šç¤¾å
                                            <% } else if (key === 'position') { %>å½¹è·
                                            <% } else if (key === 'contact_info') { %>é€£çµ¡å…ˆ
                                            <% } else if (key === 'email') { %>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                                            <% } else if (key === 'phone') { %>é›»è©±ç•ªå·
                                            <% } else if (key === 'age') { %>å¹´é½¢
                                            <% } else if (key === 'gender') { %>æ€§åˆ¥
                                            <% } else if (key === 'occupation') { %>è·æ¥­
                                            <% } else if (key === 'address') { %>ä½æ‰€
                                            <% } else if (key === 'dietary_restrictions') { %>é£Ÿäº‹åˆ¶é™
                                            <% } else if (key === 'emergency_contact') { %>ç·Šæ€¥é€£çµ¡å…ˆ
                                            <% } else if (key === 'participation_method') { %>å‚åŠ æ–¹æ³•
                                            <% } else { %><%= key %>
                                            <% } %>
                                        </th>
                                    <% }); %>
                                    <th>äºˆç´„æ—¥æ™‚</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% reservations.forEach(function(reservation, index) { %>
                                    <tr>
                                        <td><%= index + 1 %></td>
                                        <td class="reservation-code"><%= reservation.reservation_code %></td>
                                        <% fieldKeys.forEach(function(key) { %>
                                            <td><%= reservation.parsed_data[key] || '-' %></td>
                                        <% }); %>
                                        <td><%= new Date(reservation.created_at).toLocaleString('ja-JP') %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- çµ±è¨ˆæƒ…å ± -->
                    <div class="statistics">
                        <h4>çµ±è¨ˆæƒ…å ±</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">ç·äºˆç´„æ•°</span>
                                <span class="stat-value"><%= reservations.length %></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ®‹ã‚Šå¸­æ•°</span>
                                <span class="stat-value"><%= event.capacity - reservations.length %></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ç¨¼åƒç‡</span>
                                <span class="stat-value"><%= Math.round((reservations.length / event.capacity) * 100) %>%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‚åŠ æ–¹æ³•åˆ¥çµ±è¨ˆï¼ˆé¸æŠè‚¢ãŒã‚ã‚‹å ´åˆï¼‰ -->
                    <% if (event.participation_options) { %>
                        <div class="participation-stats">
                            <h4>å‚åŠ æ–¹æ³•åˆ¥çµ±è¨ˆ</h4>
                            <div class="participation-grid">
                                <% 
                                    const options = JSON.parse(event.participation_options);
                                    options.forEach(option => {
                                        const count = reservations.filter(r => r.parsed_data.participation_method === option).length;
                                %>
                                    <div class="participation-item">
                                        <span class="participation-option"><%= option %></span>
                                        <span class="participation-count"><%= count %>å</span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>
                    
                    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥çµ±è¨ˆ -->
                    <% if (fieldKeys.includes('gender')) { %>
                        <div class="field-stats">
                            <h4>æ€§åˆ¥çµ±è¨ˆ</h4>
                            <div class="field-stats-grid">
                                <% 
                                    const genderStats = {};
                                    reservations.forEach(r => {
                                        const gender = r.parsed_data.gender || 'æœªå›ç­”';
                                        genderStats[gender] = (genderStats[gender] || 0) + 1;
                                    });
                                    Object.keys(genderStats).forEach(gender => {
                                %>
                                    <div class="field-stat-item">
                                        <span class="field-stat-label"><%= gender %></span>
                                        <span class="field-stat-value"><%= genderStats[gender] %>å</span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% } %>
                <% } %>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2024 äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>
    
    <script>
        function printReservations() {
            window.print();
        }
        
        function exportCSV() {
            const table = document.getElementById('reservationsTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => {
                    const content = cell.textContent.trim();
                    // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
                    if (content.includes(',') || content.includes('"') || content.includes('\n')) {
                        return `"${content.replace(/"/g, '""')}"`;
                    }
                    return content;
                }).join(',');
            }).join('\n');
            
            // BOMä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆExcelå¯¾å¿œï¼‰
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const eventTitle = '<%= event.title %>';
            const eventDate = '<%= event.date %>';
            const fileName = `${eventTitle}_äºˆç´„è€…ä¸€è¦§_${eventDate}.csv`;
            
            if (navigator.msSaveBlob) {
                // IEå¯¾å¿œ
                navigator.msSaveBlob(blob, fileName);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤ºï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
        document.querySelectorAll('.reservations-table tbody tr').forEach(row => {
            row.addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
        });
    </script>
    
    <style>
        .event-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .event-type-badge.business {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .event-type-badge.personal {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .export-btn {
            background-color: #28a745;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #218838;
        }
        
        .participation-stats, .field-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .participation-grid, .field-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .participation-item, .field-stat-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .participation-option, .field-stat-label {
            font-weight: bold;
        }
        
        .participation-count, .field-stat-value {
            background-color: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        @media print {
            .quick-actions, .back-link, footer, header .back-link {
                display: none !important;
            }
            
            .container {
                margin: 0;
                padding: 0;
            }
            
            .reservations-table {
                font-size: 10px;
            }
            
            .reservations-table td, .reservations-table th {
                padding: 6px 4px;
            }
        }
        
        @media (max-width: 768px) {
            .reservations-table {
                font-size: 0.7rem;
            }
            
            .reservations-table td, .reservations-table th {
                padding: 4px 2px;
            }
        }
    </style>
</body>
</html>
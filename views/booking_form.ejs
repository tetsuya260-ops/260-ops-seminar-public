<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  - <%= event.title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><%= event.event_type === 'business' ? 'ã‚»ãƒŸãƒŠãƒ¼' : 'ã‚¤ãƒ™ãƒ³ãƒˆ' %>äºˆç´„</h1>
            <a href="/" class="back-link">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
        </header>
        
        <main>
            <div class="event-summary <%= event.event_type %>">
                <h2><%= event.title %></h2>
                <div class="event-details">
                    <p><span class="icon">ğŸ“…</span> <%= event.formatted_date %> <%= event.formatted_time %></p>
                    <p><span class="icon">ğŸ‘¥</span> æ®‹ã‚Š <%= event.available_count %> å¸­ / å®šå“¡ <%= event.capacity %> å</p>
                    <% if (event.description) { %>
                        <p class="description"><%= event.description %></p>
                    <% } %>
                </div>
            </div>
            
            <form action="/book" method="POST" class="booking-form" id="bookingForm">
                <input type="hidden" name="event_id" value="<%= event.id %>">
                
                <!-- å‚åŠ æ–¹æ³•é¸æŠï¼ˆé¸æŠè‚¢ãŒã‚ã‚‹å ´åˆï¼‰ -->
                <% if (event.parsed_options && event.parsed_options.length > 0) { %>
                    <div class="form-group">
                        <label for="participation_method">å‚åŠ æ–¹æ³• <span class="required">*</span></label>
                        <select id="participation_method" name="participation_method" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <% event.parsed_options.forEach(function(option) { %>
                                <option value="<%= option %>"><%= option %></option>
                            <% }); %>
                        </select>
                    </div>
                <% } %>
                
                <!-- å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <% formFields.forEach(function(field, index) { %>
                    <div class="form-group">
                        <label for="<%= field.field_key %>">
                            <%= field.field_name %>
                            <% if (field.required) { %>
                                <span class="required">*</span>
                            <% } %>
                        </label>
                        
                        <% if (field.field_type === 'text') { %>
                            <input type="text" 
                                   id="<%= field.field_key %>" 
                                   name="<%= field.field_key %>" 
                                   <%= field.required ? 'required' : '' %>
                                   placeholder="<%= field.placeholder || '' %>">
                        
                        <% } else if (field.field_type === 'email') { %>
                            <input type="email" 
                                   id="<%= field.field_key %>" 
                                   name="<%= field.field_key %>" 
                                   <%= field.required ? 'required' : '' %>
                                   placeholder="<%= field.placeholder || '' %>">
                        
                        <% } else if (field.field_type === 'tel') { %>
                            <input type="tel" 
                                   id="<%= field.field_key %>" 
                                   name="<%= field.field_key %>" 
                                   <%= field.required ? 'required' : '' %>
                                   placeholder="<%= field.placeholder || '' %>">
                        
                        <% } else if (field.field_type === 'number') { %>
                            <input type="number" 
                                   id="<%= field.field_key %>" 
                                   name="<%= field.field_key %>" 
                                   <%= field.required ? 'required' : '' %>
                                   placeholder="<%= field.placeholder || '' %>">
                        
                        <% } else if (field.field_type === 'select') { %>
                            <select id="<%= field.field_key %>" 
                                    name="<%= field.field_key %>" 
                                    <%= field.required ? 'required' : '' %>>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <% if (field.field_options) { %>
                                    <% field.field_options.forEach(function(option) { %>
                                        <option value="<%= option %>"><%= option %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        
                        <% } else if (field.field_type === 'textarea') { %>
                            <textarea id="<%= field.field_key %>" 
                                      name="<%= field.field_key %>" 
                                      <%= field.required ? 'required' : '' %>
                                      placeholder="<%= field.placeholder || '' %>"
                                      rows="3"></textarea>
                        <% } %>
                        
                        <% if (field.description) { %>
                            <small class="field-description"><%= field.description %></small>
                        <% } %>
                    </div>
                <% }); %>
                
                <button type="submit" class="submit-btn">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
            </form>
            
            <div class="notice">
                <h3>ã”æ³¨æ„äº‹é …</h3>
                <ul>
                    <li>äºˆç´„ç¢ºå®šå¾Œã€äºˆç´„ã‚³ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚å½“æ—¥ã¾ã§ã«å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</li>
                    <li>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€äºˆç´„ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã™ã€‚</li>
                    <li>å®šå“¡ã«é”ã—æ¬¡ç¬¬ã€å—ä»˜ã‚’çµ‚äº†ã„ãŸã—ã¾ã™ã€‚</li>
                    <% if (event.parsed_options && event.parsed_options.length > 0) { %>
                        <li>å‚åŠ æ–¹æ³•ã«ã‚ˆã£ã¦æ–™é‡‘ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
                    <% } %>
                </ul>
            </div>
        </main>
        
        <footer>
            <p>&copy; 2024 äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </p>
        </footer>
    </div>
    
    <script>
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            const inputs = this.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                    showFieldError(input, 'å¿…é ˆé …ç›®ã§ã™');
                } else {
                    input.classList.remove('error');
                    clearFieldError(input);
                    
                    // ç‰¹å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (input.type === 'email') {
                        if (!validateEmail(input.value)) {
                            isValid = false;
                            input.classList.add('error');
                            showFieldError(input, 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        }
                    }
                    
                    if (input.type === 'tel') {
                        if (!validatePhoneNumber(input.value)) {
                            isValid = false;
                            input.classList.add('error');
                            showFieldError(input, 'æ­£ã—ã„é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        }
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('å…¥åŠ›å†…å®¹ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
            }
        });
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
        function showFieldError(input, message) {
            clearFieldError(input);
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.color = '#dc3545';
            errorDiv.style.fontSize = '0.8rem';
            errorDiv.style.marginTop = '4px';
            
            input.parentNode.appendChild(errorDiv);
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ã‚¯ãƒªã‚¢
        function clearFieldError(input) {
            const errorMessage = input.parentNode.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.remove();
            }
        }
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function validatePhoneNumber(phone) {
            const phoneRegex = /^[\d\-\+\(\)\s]+$/;
            return phoneRegex.test(phone) && phone.length >= 10;
        }
        
        // é›»è©±ç•ªå·ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        document.querySelectorAll('input[type="tel"]').forEach(input => {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^\d]/g, '');
                
                if (value.length >= 6) {
                    if (value.length <= 10) {
                        value = value.replace(/(\d{2,4})(\d{2,4})(\d{2,4})/, '$1-$2-$3');
                    } else {
                        value = value.replace(/(\d{2,4})(\d{2,4})(\d{4})/, '$1-$2-$3');
                    }
                }
                
                e.target.value = value;
            });
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.classList.add('error');
                    showFieldError(this, 'å¿…é ˆé …ç›®ã§ã™');
                } else {
                    this.classList.remove('error');
                    clearFieldError(this);
                }
            });
            
            input.addEventListener('input', function() {
                if (this.classList.contains('error') && this.value.trim()) {
                    this.classList.remove('error');
                    clearFieldError(this);
                }
            });
        });
    </script>
    
    <style>
        .field-description {
            color: #666;
            font-style: italic;
            font-size: 0.85rem;
            margin-top: 4px;
            display: block;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }
        
        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
</body>
</html>